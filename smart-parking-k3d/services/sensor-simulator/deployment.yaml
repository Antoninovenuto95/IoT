# Manifest Kubernetes per il simulatore sensori Smart Parking
# Definisce il Deployment del pod sensor-simulator
apiVersion: apps/v1
kind: Deployment
metadata:
  # Nome del Deployment
  name: sensor-simulator
spec:
  replicas: 1 # Un solo pod
  selector:
    matchLabels:
      app: sensor-simulator
  template:
    metadata:
      labels:
        app: sensor-simulator
    spec:
      containers:
      - name: sensor-simulator
        image: smart-parking/sensor-simulator:latest # Immagine Docker simulatore
        imagePullPolicy: IfNotPresent
        env:
        - name: BROKER_HOST
          value: mosquitto # Host del broker MQTT
        - name: BROKER_PORT
          value: "8883"   # Porta MQTT TLS
        - name: MQTT_TLS
          value: "1"      # Abilita TLS/mTLS
        - name: MQTT_CA
          value: /etc/mqtt/ca.crt
        - name: MQTT_CERT
          value: /etc/mqtt/client.crt
        - name: MQTT_KEY
          value: /etc/mqtt/client.key
        - name: LOT_ID
          value: "A"       # ID parcheggio simulato
        - name: NUM_SPACES
          value: "10"     # Numero stalli simulati
        - name: PUBLISH_INTERVAL
          value: "2"      # Intervallo pubblicazione
        volumeMounts:
        - name: mqtt-client
          mountPath: /etc/mqtt   # Monta i certificati MQTT
          readOnly: true
      volumes:
      - name: mqtt-client
        secret:
          secretName: mqtt-client-sensor # Secret con certificati client MQTT
